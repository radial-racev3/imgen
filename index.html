<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a polished dark theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark GitHub background color */
            color: #c9d1d9;
        }
        .scroll-area {
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }
        .history-item {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        #loading-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 20;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <!-- Main Container -->
    <div class="flex flex-col lg:flex-row gap-6 scroll-area">
        
        <!-- Controls & Main Display (Left/Top) -->
        <div class="lg:w-3/4">
            <header class="mb-6">
                <h1 class="text-3xl font-extrabold text-yellow-400">Gemini Image Forge</h1>
                <p class="text-gray-400 mt-1">Generate highly detailed images using the Imagen 3.0 model.</p>
            </header>
            
            <!-- Generation Form -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-6 border border-gray-700">
                <label for="prompt" class="block text-lg font-semibold mb-2 text-yellow-300">Image Prompt</label>
                <textarea id="prompt" rows="3" placeholder="A majestic cybernetic dragon perched on a neon skyscraper, photorealistic, cinematic lighting, 8k resolution."
                          class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
                
                <div class="mt-4 flex flex-col sm:flex-row gap-4">
                    <!-- Aspect Ratio Selector -->
                    <div class="flex-grow">
                        <label for="aspectRatio" class="block text-sm font-medium mb-1 text-gray-400">Aspect Ratio</label>
                        <select id="aspectRatio" class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:ring-2 focus:ring-yellow-500">
                            <option value="1:1">Square (1:1)</option>
                            <option value="16:9">Landscape (16:9)</option>
                            <option value="9:16">Portrait (9:16)</option>
                            <option value="4:3">Desktop (4:3)</option>
                        </select>
                    </div>

                    <!-- Generate Button -->
                    <div class="sm:self-end pt-4 sm:pt-0">
                        <button onclick="generateImage()" id="generateButton"
                                class="w-full sm:w-auto px-8 py-3 bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-extrabold rounded-lg transition duration-200 shadow-xl disabled:opacity-50">
                            Generate Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Image Display -->
            <div class="relative bg-gray-900 border border-gray-700 rounded-xl shadow-2xl aspect-square md:aspect-video overflow-hidden">
                <img id="mainImage" src="https://placehold.co/1600x900/1e293b/94a3b8?text=Your+AI+Creation+Appears+Here" alt="Generated Image" 
                     class="w-full h-full object-cover rounded-xl" onerror="this.onerror=null; this.src='https://placehold.co/1600x900/1e293b/94a3b8?text=Error+Loading+Image'" />
                
                <!-- Loading Overlay -->
                <div id="loading-overlay" class="absolute inset-0 flex items-center justify-center hidden">
                    <div class="text-center">
                        <svg class="animate-spin h-10 w-10 text-yellow-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-3 text-yellow-400 font-semibold text-lg">Forging Reality...</p>
                    </div>
                </div>

                <!-- Error Display -->
                <p id="error-display" class="absolute top-4 left-4 p-2 bg-red-800 text-red-200 rounded-lg shadow-lg hidden">An error occurred.</p>

                <!-- Download Button (New Feature) -->
                <button onclick="downloadImage()" id="downloadButton"
                        class="absolute bottom-4 right-4 px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-gray-900 font-bold rounded-lg transition duration-200 shadow-xl hidden" disabled>
                    Download
                </button>
            </div>
        </div>
        
        <!-- History Panel (Right/Bottom) -->
        <div class="lg:w-1/4">
            <h2 class="text-2xl font-bold mb-4 text-yellow-400 border-b border-gray-700 pb-2">Generation History</h2>
            <div id="history-container" class="grid grid-cols-2 gap-4 lg:grid-cols-1">
                <p id="history-placeholder" class="text-gray-500 text-sm">Generated images will appear here. Click to view them larger.</p>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // Global variables provided by the environment
        const API_KEY = ""; // Canvas will automatically provide the key. (Do not change this line)
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${API_KEY}`;
        
        const promptInput = document.getElementById('prompt');
        const aspectRatioSelect = document.getElementById('aspectRatio');
        const generateButton = document.getElementById('generateButton');
        const mainImage = document.getElementById('mainImage');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorDisplay = document.getElementById('error-display');
        const historyContainer = document.getElementById('history-container');
        const historyPlaceholder = document.getElementById('history-placeholder');
        
        // Download button variable
        const downloadButton = document.getElementById('downloadButton');

        let imageHistory = [];

        // Common negative prompt to improve image quality
        const NEGATIVE_PROMPT = "low resolution, blurry, distorted, grainy, text, watermark, extra fingers, malformed hands, ugly, tiling, cropped, signature, logo, duplicate";

        // --- Utility Functions ---

        function toggleLoading(isLoading) {
            loadingOverlay.classList.toggle('hidden', !isLoading);
            generateButton.disabled = isLoading;
            promptInput.disabled = isLoading;
            aspectRatioSelect.disabled = isLoading;
            // Disable download button while loading
            downloadButton.disabled = isLoading; 

            if (isLoading) {
                errorDisplay.classList.add('hidden');
                generateButton.textContent = "Forging Reality...";
            } else {
                generateButton.textContent = "Generate Image";
            }
        }

        function displayError(message) {
            errorDisplay.textContent = `Error: ${message}`;
            errorDisplay.classList.remove('hidden');
        }

        function updateHistory() {
            if (historyPlaceholder) historyPlaceholder.classList.add('hidden');
            
            // Clear current history display
            historyContainer.innerHTML = ''; 

            imageHistory.slice().reverse().forEach((item, index) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = item.url;
                thumbnail.alt = item.prompt.substring(0, 30) + "...";
                thumbnail.className = 'w-full h-auto object-cover rounded-lg shadow-md border-2 border-gray-700 history-item';
                thumbnail.onclick = () => {
                    mainImage.src = item.url; // Set the main image to the clicked history item
                    promptInput.value = item.prompt; // Load the prompt back into the input
                    downloadButton.classList.remove('hidden'); // Ensure download is visible
                    downloadButton.disabled = false;
                };
                historyContainer.appendChild(thumbnail);
            });
        }
        
        // Function to handle image download
        function downloadImage() {
            const url = mainImage.src;
            if (url.startsWith('data:image/png;base64,')) {
                // 1. Create a temporary anchor element
                const a = document.createElement('a');
                a.href = url;
                
                // 2. Generate a filename from the prompt and timestamp
                let filename = promptInput.value.trim().substring(0, 30).replace(/[^a-z0-9]/gi, '_').toLowerCase();
                if (filename.length === 0) {
                    filename = 'ai_image';
                }
                a.download = `${filename}_${Date.now()}.png`;

                // 3. Programmatically click the link to trigger the download
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                displayError("No generated image data available for download.");
            }
        }

        // --- Imagen API Call Logic ---

        async function generateImage(retryCount = 0) {
            const userPrompt = promptInput.value.trim();
            const selectedAspect = aspectRatioSelect.value;

            if (!userPrompt) {
                displayError("Please enter a detailed prompt to generate an image.");
                return;
            }

            toggleLoading(true);

            const payload = {
                instances: [{
                    prompt: userPrompt,
                    aspectRatio: selectedAspect,
                    negativePrompt: NEGATIVE_PROMPT
                }],
                parameters: {
                    sampleCount: 1, // Only generate 1 image
                }
            };

            try {
                const response = await fetch(IMAGEN_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;

                    mainImage.src = imageUrl; // Update main image
                    
                    // Show and enable download button on success
                    downloadButton.classList.remove('hidden'); 
                    downloadButton.disabled = false;

                    // Add to history
                    imageHistory.push({
                        url: imageUrl,
                        prompt: userPrompt,
                        aspectRatio: selectedAspect
                    });

                    updateHistory();
                } else {
                    throw new Error("API did not return a valid image.");
                }
            } catch (error) {
                console.error("Imagen API Error:", error);
                
                // Implement exponential backoff for throttling/transient errors
                if (retryCount < 3) {
                    const delay = Math.pow(2, retryCount) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    await generateImage(retryCount + 1);
                } else {
                    displayError(`Failed to generate image after retries. (${error.message || 'Check console for details'})`);
                }
            } finally {
                toggleLoading(false);
            }
        }

        // Set initial focus
        window.onload = () => {
            promptInput.focus();
        };

    </script>
</body>
</html>
